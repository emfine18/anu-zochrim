<!-- ================= SEARCH THE DATABASE ================= -->
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
#search-section {
  max-width: 1200px;
  margin: 64px auto;
  padding: 0 24px;
  font-family: "Noto Serif", serif;
}

#search-section h2 {
  color: #556b2f;
  font-size: 1.6rem;
  text-transform: uppercase;
  margin-bottom: 24px;
}

.row {
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
  margin-bottom: 16px;
}

select, input {
  padding: 14px;
  font-family: "Noto Serif", serif;
  font-size: 0.95rem;
  border: 1px solid #cbd5e1;
  border-radius: 4px;
  min-width: 220px;
}

button {
  padding: 14px 28px;
  font-family: "Noto Serif", serif;
  background: #556b2f;
  color: #ffffff;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

button.reset {
  background: #e5e7eb;
  color: #334155;
}

.hidden { display: none; }

.result {
  border-bottom: 1px solid #e5e7eb;
  padding: 12px 0;
}
</style>

<section id="search-section">
  <h2>Search the Database</h2>

  <!-- TOP CONTROLS -->
  <div class="row">
    <select id="searchBy">
      <option value="">Search by</option>
      <option value="name">Name</option>
      <option value="age">Age</option>
      <option value="country">Country</option>
      <option value="deathdate">Death date</option>
    </select>

    <select id="role">
      <option value="">All roles</option>
      <option>Civilian</option>
      <option>Soldier</option>
      <option>Police</option>
      <option>Hostage</option>
    </select>

    <select id="gender">
      <option value="">Gender</option>
      <option value="M">Male</option>
      <option value="F">Female</option>
    </select>
  </div>

  <!-- NAME -->
  <div id="nameField" class="row hidden">
    <input id="firstName" placeholder="First name">
    <input id="middleName" placeholder="Middle name">
    <input id="lastName" placeholder="Last name">
  </div>

  <!-- AGE -->
  <div id="ageField" class="row hidden">
    <input id="age" type="number" placeholder="Age">
  </div>

  <!-- COUNTRY -->
  <div id="countryField" class="row hidden">
    <input id="country" placeholder="Country (English)">
  </div>

  <!-- DATE -->
  <div id="dateField" class="row hidden">
    <input id="mmdd" placeholder="MM/DD">
  </div>

  <!-- BUTTONS -->
  <div class="row">
    <button id="searchBtn" disabled>Search</button>
    <button class="reset" onclick="resetSearch()">Reset</button>
  </div>

  <div id="results"></div>
</section>

<script>
let DATA = [];
let loaded = false;

/* LOAD CSV */
Papa.parse(
  "https://raw.githubusercontent.com/yuval-harpaz/alarms/refs/heads/master/data/oct7database.csv",
  {
    download: true,
    header: true,
    complete: res => {
      DATA = res.data.filter(r => r && r["שם פרטי"]);
      loaded = true;
      document.getElementById("searchBtn").disabled = false;
    }
  }
);

/* TOGGLE INPUTS */
document.getElementById("searchBy").addEventListener("change", () => {
  ["nameField","ageField","countryField","dateField"]
    .forEach(id => document.getElementById(id).classList.add("hidden"));

  const map = {
    name: "nameField",
    age: "ageField",
    country: "countryField",
    deathdate: "dateField"
  };

  if (map[searchBy.value]) {
    document.getElementById(map[searchBy.value]).classList.remove("hidden");
  }

  results.innerHTML = "";
});

/* MM/DD MATCH */
function matchMMDD(dateStr, mmdd) {
  if (!dateStr || !mmdd) return false;
  const d = new Date(dateStr);
  if (isNaN(d)) return false;
  const f =
    String(d.getMonth()+1).padStart(2,"0") + "/" +
    String(d.getDate()).padStart(2,"0");
  return f === mmdd;
}

/* SEARCH */
document.getElementById("searchBtn").onclick = () => {
  if (!loaded) return;

  const type = searchBy.value;
  const roleVal = role.value;
  const genderVal = gender.value;

  const res = DATA.filter(r => {
    if (roleVal && r.Role !== roleVal) return false;
    if (genderVal && r.Gender !== genderVal) return false;

    if (type === "name") {
      const fn = firstName.value || "";
      const mn = middleName.value || "";
      const ln = lastName.value || "";

      if (fn && !r["שם פרטי"]?.includes(fn)) return false;
      if (mn && !r["שם נוסף"]?.includes(mn)) return false;
      if (ln && !r["שם משפחה"]?.includes(ln)) return false;

      return true;
    }

    if (type === "age") return String(r.Age) === age.value;
    if (type === "country") return r.Country?.toLowerCase().includes(country.value.toLowerCase());
    if (type === "deathdate") return matchMMDD(r["Death date"], mmdd.value);

    return false;
  });

  results.innerHTML = res.length
    ? res.map(r => `
      <div class="result">
        <strong>${r["שם פרטי"]} ${r["שם משפחה"]}</strong><br>
        ${r.Role || ""} · ${r.Country || ""} · ${r["Death date"] || ""}
      </div>
    `).join("")
    : "<p>No results found.</p>";
};

/* RESET */
function resetSearch() {
  document.querySelectorAll("input,select").forEach(e => e.value = "");
  ["nameField","ageField","countryField","dateField"]
    .forEach(id => document.getElementById(id).classList.add("hidden"));
  results.innerHTML = "";
}
</script>
<!-- ================= END SEARCH ================= -->
