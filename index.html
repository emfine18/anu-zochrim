<!-- =====================================================
     OCT 7 DATABASE — FULL TABLE + FILTERS
===================================================== -->

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<!-- DataTables -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<!-- PapaParse -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
#oct7-wrapper {
  max-width: 1200px;
  margin: 64px auto;
  padding: 0 24px;
  font-family: "Noto Serif", serif;
}

#oct7-wrapper h2 {
  font-size: 1.4rem;
  text-transform: uppercase;
  color: #556b2f;
  margin-bottom: 20px;
}

#oct7-filters {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 20px;
}

#oct7-filters input,
#oct7-filters select,
#oct7-filters button {
  padding: 10px 12px;
  font-family: "Noto Serif", serif;
  font-size: 0.9rem;
}

#oct7-filters button {
  background: #556b2f;
  color: #fff;
  border: none;
  cursor: pointer;
}

#oct7-filters button.reset {
  background: #e5e7eb;
  color: #334155;
}

#oct7table {
  width: 100%;
}
</style>

<section id="oct7-wrapper" style="display:none;">

  <h2>Search the Database</h2>

  <div id="oct7-filters">
    <input id="globalSearch" placeholder="Search all columns">

    <select id="filterGender"><option value="">Gender</option></select>
    <select id="filterCountry"><option value="">Country</option></select>
    <select id="filterRole"><option value="">Role</option></select>
    <select id="filterParty"><option value="">Party</option></select>
    <select id="filterStatus"><option value="">Status</option></select>
    <select id="filterFront"><option value="">Front</option></select>
    <select id="filterCause"><option value="">Cause of Death</option></select>

    <label>Event date from <input type="date" id="eventMin"></label>
    <label>to <input type="date" id="eventMax"></label>

    <label>Death date from <input type="date" id="deathMin"></label>
    <label>to <input type="date" id="deathMax"></label>

    <button class="reset" id="resetTable">Reset</button>
  </div>

  <table id="oct7table" class="display">
    <thead></thead>
    <tbody></tbody>
  </table>

</section>

<script>
let table;
let rawData = [];

Papa.parse(
  "https://raw.githubusercontent.com/yuval-harpaz/alarms/refs/heads/master/data/oct7database.csv",
  {
    download: true,
    header: true,
    complete: function(results) {
      rawData = results.data.filter(r => r.pid);
      initTable();
      document.getElementById("oct7-wrapper").style.display = "block";
    }
  }
);

function initTable() {
  const columns = Object.keys(rawData[0]).map(k => ({ title: k, data: k }));

  $('#oct7table thead').html(
    '<tr>' + columns.map(c => `<th>${c.title}</th>`).join('') + '</tr>'
  );

  table = $('#oct7table').DataTable({
    data: rawData,
    columns: columns,
    paging: false,
    autoWidth: false
  });

  populateDropdown("filterGender", "Gender");
  populateDropdown("filterCountry", "Country");
  populateDropdown("filterRole", "Role");
  populateDropdown("filterParty", "Party");
  populateDropdown("filterStatus", "Status");
  populateDropdown("filterFront", "front");
  populateDropdown("filterCause", "סיבת המוות");

  $('#globalSearch').on('input', e => table.search(e.target.value).draw());

  hookFilter("filterGender", "Gender");
  hookFilter("filterCountry", "Country");
  hookFilter("filterRole", "Role");
  hookFilter("filterParty", "Party");
  hookFilter("filterStatus", "Status");
  hookFilter("filterFront", "front");
  hookFilter("filterCause", "סיבת המוות");

  dateFilter("Event date", "eventMin", "eventMax");
  dateFilter("Death date", "deathMin", "deathMax");

  $('#resetTable').on('click', () => {
    $('input, select').val('');
    table.search('').columns().search('').draw();
  });
}

function populateDropdown(id, col) {
  const idx = table.column(`${col}:name`).index() ?? table.columns().indexes().toArray().find(i => table.column(i).header().innerText === col);
  const values = [...new Set(rawData.map(r => r[col]).filter(Boolean))].sort();
  const sel = document.getElementById(id);
  values.forEach(v => sel.innerHTML += `<option>${v}</option>`);
}

function hookFilter(selectId, colName) {
  const idx = table.columns().indexes().toArray().find(i => table.column(i).header().innerText === colName);
  $(`#${selectId}`).on('change', function() {
    table.column(idx).search(this.value).draw();
  });
}

function dateFilter(colName, minId, maxId) {
  const idx = table.columns().indexes().toArray().find(i => table.column(i).header().innerText === colName);
  $.fn.dataTable.ext.search.push(function(settings, data) {
    const min = document.getElementById(minId).value;
    const max = document.getElementById(maxId).value;
    const d = data[idx];
    if (!d) return true;
    const dt = new Date(d);
    if (min && dt < new Date(min)) return false;
    if (max && dt > new Date(max)) return false;
    return true;
  });
  $(`#${minId}, #${maxId}`).on('change', () => table.draw());
}
</script>

<!-- =====================================================
     END OCT 7 DATABASE — FULL TABLE + FILTERS
===================================================== -->
