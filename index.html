<!-- ================= SEARCH THE DATABASE ================= -->
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
#search-section {
  max-width: 1200px;
  margin: 64px auto;
  padding: 0 24px;
  font-family: "Noto Serif", serif;
}

#search-section h2 {
  color: #556b2f;
  font-size: 1.6rem;
  text-transform: uppercase;
  margin-bottom: 24px;
}

.search-row {
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
  margin-bottom: 16px;
}

select, input {
  padding: 14px;
  font-family: "Noto Serif", serif;
  font-size: 0.95rem;
  border: 1px solid #cbd5e1;
  border-radius: 4px;
  min-width: 220px;
}

button {
  padding: 14px 28px;
  font-family: "Noto Serif", serif;
  background: #556b2f;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

button.reset {
  background: #e5e7eb;
  color: #334155;
}

.hidden { display: none; }

.result {
  border-bottom: 1px solid #e5e7eb;
  padding: 12px 0;
}
</style>

<section id="search-section">
  <h2>Search the Database</h2>

  <!-- TOP CONTROLS -->
  <div class="search-row">
    <select id="searchBy">
      <option value="">Search by</option>
      <option value="name">Name</option>
      <option value="gender">Gender</option>
      <option value="country">Country</option>
      <option value="age">Age</option>
      <option value="deathdate">Death Date (MM/DD)</option>
    </select>

    <select id="role">
      <option value="">All roles</option>
      <option>Soldier</option>
      <option>Civilian</option>
      <option>Police</option>
      <option>Hostage</option>
    </select>
  </div>

  <!-- NAME -->
  <div id="nameFields" class="search-row hidden">
    <input id="firstName" placeholder="First name">
    <input id="middleName" placeholder="Middle name">
    <input id="lastName" placeholder="Last name">
  </div>

  <!-- GENDER -->
  <div id="genderField" class="search-row hidden">
    <select id="gender">
      <option value="">Select gender</option>
      <option value="Male">Male</option>
      <option value="Female">Female</option>
    </select>
  </div>

  <!-- COUNTRY -->
  <div id="countryField" class="search-row hidden">
    <input id="country" placeholder="Country (English)">
  </div>

  <!-- AGE -->
  <div id="ageField" class="search-row hidden">
    <input id="age" type="number" placeholder="Age">
  </div>

  <!-- DATE -->
  <div id="dateField" class="search-row hidden">
    <input id="mmdd" placeholder="MM/DD">
  </div>

  <!-- BUTTONS -->
  <div class="search-row">
    <button onclick="runSearch()">Search</button>
    <button class="reset" onclick="resetSearch()">Reset</button>
  </div>

  <!-- RESULTS -->
  <div id="results"></div>
</section>

<script>
let DATA = [];

Papa.parse(
  "https://raw.githubusercontent.com/yuval-harpaz/alarms/refs/heads/master/data/oct7database.csv",
  {
    download: true,
    header: true,
    complete: res => DATA = res.data
  }
);

// toggle fields
document.getElementById("searchBy").addEventListener("change", () => {
  document.querySelectorAll(".search-row.hidden").forEach(e => e.classList.add("hidden"));
  document.getElementById("results").innerHTML = "";

  const map = {
    name: "nameFields",
    gender: "genderField",
    country: "countryField",
    age: "ageField",
    deathdate: "dateField"
  };
  const v = searchBy.value;
  if (map[v]) document.getElementById(map[v]).classList.remove("hidden");
});

function mmddMatch(dateStr, mmdd) {
  if (!dateStr) return false;
  const d = new Date(dateStr);
  if (isNaN(d)) return false;
  const f =
    String(d.getMonth()+1).padStart(2,"0") + "/" +
    String(d.getDate()).padStart(2,"0");
  return f === mmdd;
}

function runSearch() {
  const type = searchBy.value;
  const role = document.getElementById("role").value;

  const res = DATA.filter(r => {
    if (role && r.Role !== role) return false;

    if (type === "name") {
      return (
        (!firstName.value || r["שם פרטי"]?.includes(firstName.value)) &&
        (!middleName.value || r["שם נוסף"]?.includes(middleName.value)) &&
        (!lastName.value || r["שם משפחה"]?.includes(lastName.value))
      );
    }

    if (type === "gender") return r.Gender === gender.value;
    if (type === "country") return r.Country?.toLowerCase().includes(country.value.toLowerCase());
    if (type === "age") return String(r.Age) === age.value;
    if (type === "deathdate") return mmddMatch(r["Death date"], mmdd.value);

    return false;
  });

  results.innerHTML = res.length
    ? res.map(r => `
      <div class="result">
        <strong>${r["שם פרטי"] || ""} ${r["שם משפחה"] || ""}</strong><br>
        ${r.Role || ""} · ${r.Country || ""} · ${r["Death date"] || ""}
      </div>`).join("")
    : "<p>No results found.</p>";
}

function resetSearch() {
  document.querySelectorAll("input, select").forEach(e => e.value = "");
  document.querySelectorAll(".search-row.hidden").forEach(e => e.classList.add("hidden"));
  results.innerHTML = "";
}
</script>
<!-- ================= END SEARCH ================= -->

