<!-- =====================================================
     OCT 7 DATABASE — SEARCH BY CONTROLLER
===================================================== -->

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
#search-wrapper {
  max-width: 1200px;
  margin: 64px auto;
  padding: 0 24px;
  font-family: "Noto Serif", serif;
}

#search-wrapper h2 {
  font-size: 1.4rem;
  text-transform: uppercase;
  color: #556b2f;
  margin-bottom: 20px;
}

.search-row {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  margin-bottom: 16px;
}

.search-row select,
.search-row input,
.search-row button {
  padding: 10px 12px;
  font-family: "Noto Serif", serif;
  font-size: 0.9rem;
}

.search-row button {
  background: #556b2f;
  color: #fff;
  border: none;
  cursor: pointer;
}

.search-row button.reset {
  background: #e5e7eb;
  color: #334155;
}

.hidden { display:none; }

#results-wrapper { display:none; margin-top:24px; }
</style>

<section id="search-wrapper">

<h2>Search the Database</h2>

<!-- SEARCH BY -->
<div class="search-row">
  <select id="searchType">
    <option value="">Search by</option>
    <option value="name">Name</option>
    <option value="gender">Gender</option>
    <option value="country">Country</option>
    <option value="role">Role</option>
    <option value="date">Death Date (MM/DD)</option>
    <option value="age">Age</option>
  </select>
</div>

<!-- NAME SEARCH -->
<div class="search-row hidden" id="search-name">
  <input id="firstName" placeholder="First name">
  <input id="middleName" placeholder="Middle name">
  <input id="lastName" placeholder="Last name">
</div>

<!-- GENDER -->
<div class="search-row hidden" id="search-gender">
  <select id="genderSelect">
    <option value="">Gender</option>
    <option>Male</option>
    <option>Female</option>
  </select>
</div>

<!-- COUNTRY -->
<div class="search-row hidden" id="search-country">
  <select id="countrySelect"></select>
</div>

<!-- ROLE -->
<div class="search-row hidden" id="search-role">
  <select id="roleSelect"></select>
</div>

<!-- DATE -->
<div class="search-row hidden" id="search-date">
  <input id="mmdd" placeholder="MM/DD">
</div>

<!-- AGE -->
<div class="search-row hidden" id="search-age">
  <input id="ageInput" type="number" placeholder="Age">
</div>

<!-- ACTIONS -->
<div class="search-row">
  <button onclick="runSearch()">Search</button>
  <button class="reset" onclick="resetSearch()">Reset</button>
</div>

<!-- RESULTS -->
<div id="results-wrapper">
  <table id="resultsTable" class="display"></table>
</div>

</section>

<script>
let data=[], table;

/* TRANSLATIONS */
const T={
  "M":"Male","F":"Female",
  "אזרח":"Civilian","חייל":"Soldier","שוטר":"Police",
  "ישראל":"Israel","ארה\"ב":"USA","בריטניה":"UK"
};

Papa.parse(
  "https://raw.githubusercontent.com/yuval-harpaz/alarms/refs/heads/master/data/oct7database.csv",
  {download:true,header:true,complete:r=>{
    data=r.data.filter(x=>x.pid);
    initTable();
    populateDropdowns();
  }}
);

function initTable(){
  const cols=Object.keys(data[0]).map(k=>({title:k,data:k,render:d=>T[d]||d||""}));
  $("#resultsTable").DataTable({data:[],columns:cols,paging:false});
  table=$("#resultsTable").DataTable();
}

function populateDropdowns(){
  const countries=[...new Set(data.map(d=>T[d.Country]||d.Country).filter(Boolean))].sort();
  countries.forEach(c=>$("#countrySelect").append(`<option>${c}</option>`));

  const roles=[...new Set(data.map(d=>T[d.Role]||d.Role).filter(Boolean))].sort();
  roles.forEach(r=>$("#roleSelect").append(`<option>${r}</option>`));
}

$("#searchType").on("change",function(){
  $(".hidden").addClass("hidden");
  $("#search-"+this.value).removeClass("hidden");
});

function runSearch(){
  const type=$("#searchType").val();
  if(!type)return;

  let results=data.filter(d=>{
    if(type==="name"){
      return (!$("#firstName").val()||d["שם פרטי"]?.includes($("#firstName").val())) &&
             (!$("#middleName").val()||d["שם נוסף"]?.includes($("#middleName").val())) &&
             (!$("#lastName").val()||d["שם משפחה"]?.includes($("#lastName").val()));
    }
    if(type==="gender") return T[d.Gender]===$("#genderSelect").val();
    if(type==="country") return (T[d.Country]||d.Country)===$("#countrySelect").val();
    if(type==="role") return (T[d.Role]||d.Role)===$("#roleSelect").val();
    if(type==="age") return String(d.Age)===$("#ageInput").val();
    if(type==="date"){
      const dt=new Date(d["Death date"]);
      const m=String(dt.getMonth()+1).padStart(2,"0")+"/"+String(dt.getDate()).padStart(2,"0");
      return m===$("#mmdd").val();
    }
  });

  table.clear().rows.add(results).draw();
  $("#results-wrapper").show();
}

function resetSearch(){
  $("input,select").val("");
  table.clear().draw();
  $("#results-wrapper").hide();
}
</script>

<!-- =====================================================
     END SEARCH BY CONTROLLER
===================================================== -->
