<script>
let table;
let rawData = [];

/* ================= TRANSLATIONS ================= */
const translations = {
  // Gender
  "M": "Male",
  "F": "Female",

  // Roles
  "אזרח": "Civilian",
  "חייל": "Soldier",
  "שוטר": "Police",
  "כבאי": "Firefighter",
  "כיתת כוננות": "Emergency Squad",
  "צוות רפואי": "Medical Team",
  "שב\"כ": "Shin Bet",

  // Countries
  "ישראל": "Israel",
  "ארה\"ב": "USA",
  "בריטניה": "UK",
  "גרמניה": "Germany",
  "צרפת": "France",
  "קנדה": "Canada",
  "אוקראינה": "Ukraine",
  "רוסיה": "Russia",
  "תאילנד": "Thailand",
  "נפאל": "Nepal",
  "הפיליפינים": "Philippines",

  // Cause of death
  "ירי": "Gunfire",
  "רקטה": "Rocket",
  "פצמ\"ר": "Mortar",
  "נ.ט.": "Anti-Tank",
  "פיגוע": "Terror Attack",
  "פיגוע ירי": "Shooting Attack",
  "פיגוע דקירה": "Stabbing Attack",
  "פיגוע דריסה": "Ramming Attack",
  "מטען": "Explosive",
  "צלף": "Sniper",
  "תאונה": "Accident"
};

/* ================= CSV LOAD ================= */
Papa.parse(
  "https://raw.githubusercontent.com/yuval-harpaz/alarms/refs/heads/master/data/oct7database.csv",
  {
    download: true,
    header: true,
    complete: function(results) {
      rawData = results.data.filter(r => r.pid);
      initTable();
      document.getElementById("oct7-wrapper").style.display = "block";
    }
  }
);

/* ================= TABLE INIT ================= */
function initTable() {
  const columns = Object.keys(rawData[0]).map(k => ({
    title: k,
    data: k,
    render: function(data) {
      return translations[data] || data || "";
    }
  }));

  $('#oct7table thead').html(
    '<tr>' + columns.map(c => `<th>${c.title}</th>`).join('') + '</tr>'
  );

  table = $('#oct7table').DataTable({
    data: rawData,
    columns: columns,
    paging: false,
    autoWidth: false
  });

  populateDropdown("filterGender", "Gender");
  populateDropdown("filterCountry", "Country");
  populateDropdown("filterRole", "Role");
  populateDropdown("filterFront", "front");
  populateDropdown("filterCause", "סיבת המוות");

  hookFilter("filterGender", "Gender");
  hookFilter("filterCountry", "Country");
  hookFilter("filterRole", "Role");
  hookFilter("filterFront", "front");
  hookFilter("filterCause", "סיבת המוות");

  dateFilter("Event date", "eventMin", "eventMax");
  dateFilter("Death date", "deathMin", "deathMax");

  $('#globalSearch').on('input', e =>
    table.search(e.target.value).draw()
  );

  $('#resetTable').on('click', () => {
    $('input, select').val('');
    table.search('').columns().search('').draw();
  });
}

/* ================= HELPERS ================= */
function populateDropdown(id, col) {
  const idx = table.columns().indexes().toArray()
    .find(i => table.column(i).header().innerText === col);

  const values = [...new Set(rawData.map(r => r[col]).filter(Boolean))]
    .map(v => translations[v] || v)
    .sort();

  const sel = document.getElementById(id);
  sel.innerHTML = `<option value="">${sel.options[0].text}</option>`;
  values.forEach(v => sel.innerHTML += `<option value="${v}">${v}</option>`);
}

function hookFilter(selectId, colName) {
  const idx = table.columns().indexes().toArray()
    .find(i => table.column(i).header().innerText === colName);

  $(`#${selectId}`).on('change', function() {
    table.column(idx).search(this.value).draw();
  });
}

function dateFilter(colName, minId, maxId) {
  const idx = table.columns().indexes().toArray()
    .find(i => table.column(i).header().innerText === colName);

  $.fn.dataTable.ext.search.push(function(settings, data) {
    const min = document.getElementById(minId).value;
    const max = document.getElementById(maxId).value;
    const d = data[idx];
    if (!d) return true;
    const dt = new Date(d);
    if (min && dt < new Date(min)) return false;
    if (max && dt > new Date(max)) return false;
    return true;
  });

  $(`#${minId}, #${maxId}`).on('change', () => table.draw());
}
</script>
